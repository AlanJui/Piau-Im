# Gemini Project Context: 閩南語漢字注音自動化系統

## 1. 專案目標 (Project Goals)

本專案旨在建立一套自動化工具，用於處理「漢字」與「台語音標」的對應、查找與 Excel 填入自動化。主要功能包含：

- 自動化將漢字與對應音標填入 Excel 儲存格。
- 支援「人工標音」與「資料庫查找」雙軌模式。
- 提供導讀模式與系統維護工具。

## 2. 核心術語定義 (Vocabulary & Terms)

- **【台語音標】(TLPA/TLPA+)**: 本系統的核心標準。TLPA+ 特色為聲母單字母化（ts→z, tsh→c），便於程式切分聲、韻、調。

- **【漢字標音】(Han-Ji-Piau-Im)**: 最終顯示給使用者看的標音（如：方音符號、POJ、BP），由【台語音標】依據 env 設定自動轉換而成。

- **【人工標音】(Manual Annotation)**: 使用者於 Excel 指定儲存格手動輸入的標音。優先權高於資料庫查找。

- **【漢字庫】(Han-Ji-Khoo)**: 位於 Ho_Lok_Ue.db 的主要資料表，包含 漢字、台羅音標、常用度等欄位。

- **【env工作表】**: 為適用於不同場合、用途，使用者需有【自行調整】的彈性，本系統為避免程式寫死，特利用 Excel 名為【env】之工作表，依使用需求自行設定，調整程式作業時的參數。
- **【導讀模式】**: 透過交叉游標指引，隱藏人工標音文字（轉為象牙白）以利誦讀。

## 3. 關鍵檔案與功能邏輯

- **PRG-a000**: Excel 單一儲存格處理邏輯（包含文章終止 φ、換行 \n 之判定）。
- **PRG-a100**: 自動化填入漢字及其語音標註至 Excel。
- **PRG-a109**: 導讀功能，控制方向鍵移動與字體顏色切換（隱藏/恢復紅色標音）。
- **PRG-a210**: 核心查找邏輯：若有【人工標音】則直接轉換，否則自【漢字庫】查找。
- **PRG-a400**: 自 Excel 活頁簿檔案，讀取：【漢字注音】工作表，每個【漢字標音行】的【漢字】、【台語音標】及【漢字標音】儲存格內容，製作引用 \<ruby\> tag 的 HTML 網頁檔案。

## 4. Excel 工作表結構與座標推算 (Crucial Design)

系統採用固定偏移量邏輯處理「漢字標音行」，每一行由 4 列 (Rows) 組成：

內容,相對 Row 位移,格式規範 (字型/顏色/大小)
人工標音,漢字Row - 2,Arial / 紅色 / 24 / 底色 #FFFFCC
台語音標,漢字Row - 1,Sitka Text / 橘色 (#FF9933) / 24
漢字,基準點 (Row),吳守禮細明台語注音 / 黑色 / 48
漢字標音,漢字Row + 1,芫荽 0.94 / 綠色 (#009900) / 26

- 水平範圍: D 欄 (Col 4) 至 R 欄 (Col 18)，每行固定 15 個字。

- 特殊符號: φ (文章終止)、\n (換行)。

## 5. 標音處理邏輯 (Processing Logic)

1. **優先權判定**:
   - 若【人工標音】有內容 $\rightarrow$ 直接採用並轉換為【漢字標音】。
   - 若【人工標音】為 = $\rightarrow$ 強制由「人工標音工作表」查找。
   - 若為 # $\rightarrow$ 取消人工指定，回歸資料庫查找。

2. **自動更正 (OP-000)**:
    處理資料庫時，c% 需校正為 tsh%，z% 校正為 ts%。

3. **方音符號解析**: 依據 Hong_Im_Tiau_Hu_Dict 將調符（ˋ, ˪, ˊ, ˫, ˙）映射為調號（2, 3, 5, 7, 8）。

## 6. 程式設計規範 (Programming Standards)

- **環境變數**: 必須從 .env 讀取 FILE_NAME 與 DATABASE 名稱。

- **效能優化**: 重置工作表時，嚴禁逐一處理儲存格，必須使用 range().clear_contents() 區域作業。

- **校稿模式 (-edit)**: 啟動 a109 時若帶此參數，不可變更【人工標音】的象牙白樣式，以利辨識。

- **異常處理**: 所有對 Excel 的修改必須包覆在 try...finally 中，確保程式中斷時能恢復樣式（如顏色還原）。
