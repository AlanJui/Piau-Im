# URS-007 實作

a850.py

這段程式碼的主要功能是從 Excel 工作表中讀取漢字及其台羅拼音，並將其匯入 SQLite 資料庫的【漢字庫】資料表中。以下是程式碼的詳細說明與執行流程：

---

### **程式碼功能概述**
1. **從 Excel 工作表讀取資料**：
   - 讀取指定工作表中的漢字、台羅拼音、常用度、摘要說明及更新時間等欄位資料。
   - 預設工作表名稱為【漢字庫】，但允許使用者透過終端機輸入參數指定其他工作表名稱。

2. **資料驗證與處理**：
   - 檢查漢字與台羅拼音是否為有效資料，若無效則跳過並記錄錯誤。
   - 將台羅拼音（TL）轉換為台語音標（TLPA）。

3. **重建 SQLite 資料表**：
   - 刪除現有的【漢字庫】資料表。
   - 根據 Excel 工作表的資料重新建立【漢字庫】資料表。
   - 插入資料並確保【漢字】與【台羅音標】的組合具有唯一性（透過 UNIQUE INDEX 實現）。

4. **錯誤處理與日誌記錄**：
   - 若發生錯誤，將錯誤訊息記錄到 `error_log.txt` 文件中。
   - 使用 `logging` 模組記錄程式執行過程。

---

### **程式碼執行流程**
1. **載入環境變數與設定日誌**：
   - 使用 `dotenv` 載入環境變數，取得 SQLite 資料庫檔案路徑。
   - 設定日誌格式與記錄等級。

2. **主程式執行**：
   - 檢查終端機輸入的參數，決定執行的模式（預設為模式 5）。
   - 取得當前作用中的 Excel 活頁簿（`wb`）。

3. **呼叫 `rebuild_database_from_excel` 函式**：
   - 檢查指定工作表是否存在。
   - 讀取工作表中的資料範圍（從 A2 開始）。
   - 連接到 SQLite 資料庫，並刪除現有的【漢字庫】資料表。
   - 重新建立【漢字庫】資料表，並插入從 Excel 讀取的資料。
   - 建立 UNIQUE INDEX 以確保資料的唯一性。

4. **錯誤處理與資源釋放**：
   - 若發生錯誤，回傳錯誤代碼並記錄錯誤訊息。
   - 關閉資料庫連接。

---

### **程式碼關鍵點說明**
1. **Excel 資料讀取**：
   - 使用 `xlwings` 套件讀取 Excel 活頁簿中的資料。
   - 資料範圍從 A2 開始，並自動擴展到整個表格。

2. **資料驗證**：
   - 檢查漢字與台羅拼音是否為空值或無效格式。
   - 若資料無效，跳過該筆資料並記錄錯誤。

3. **拼音轉換**：
   - 使用 `convert_tl_to_tlpa` 函式將台羅拼音（TL）轉換為台語音標（TLPA）。

4. **SQLite 資料表操作**：
   - 刪除舊資料表並重新建立。
   - 插入資料時，確保【漢字】與【台羅音標】的組合具有唯一性。

5. **錯誤記錄**：
   - 使用 `logging` 模組記錄程式執行過程。
   - 將無效資料記錄到 `error_log.txt` 文件中。

---

### **程式碼改進建議**
1. **增加使用者互動**：
   - 若未指定工作表名稱，可提示使用者輸入工作表名稱。
   - 提供更多錯誤提示，例如：檔案不存在、工作表不存在等。

2. **優化資料驗證**：
   - 增加對常用度、摘要說明及更新時間欄位的資料驗證。
   - 提供更詳細的錯誤訊息，例如：欄位格式錯誤、資料類型不符等。

3. **支援更多拼音系統**：
   - 除了 TL 與 TLPA，可支援其他拼音系統的轉換。

4. **效能優化**：
   - 對於大量資料，可考慮分批插入資料，避免一次性插入過多資料導致效能問題。

---

### **執行範例**
1. **終端機指令**：
   ```bash
   python a850_使用Excel重建漢字庫.py 5
   ```
   - 模式 5：從 Excel 工作表重建【漢字庫】資料表。

2. **指定工作表名稱**：
   ```bash
   python a850_使用Excel重建漢字庫.py 5 辭彙
   ```
   - 從名為【辭彙】的工作表匯入資料。

---

### **預期輸出**
1. **成功執行**：
   - 顯示「✅ `漢字庫` 資料表已成功重建！」。
   - 在 SQLite 資料庫中建立新的【漢字庫】資料表，並插入資料。

2. **錯誤情況**：
   - 若工作表不存在，顯示「⚠️ 無法找到工作表: {sheet_name}」。
   - 若資料無效，顯示「⚠️ 跳過無效資料: Excel 第 {idx} 列：缺【漢字】或【台羅音標】」。
   - 若發生其他錯誤，顯示「❌ 重建 `漢字庫` 失敗: {錯誤訊息}」。

---

### **總結**
這段程式碼實現了從 Excel 工作表匯入漢字及其拼音到 SQLite 資料庫的功能，並確保資料的唯一性與正確性。透過進一步的優化與擴充，可以提升程式的彈性與穩定性。